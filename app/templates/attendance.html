{% extends 'base.html' %}
{% block c %}
<h1 class="text-xl font-semibold mb-3">Attendance Portal</h1>

<div id="statusBox" class="mb-4 text-sm text-gray-700">
  <p><b>Date:</b> {{ now().strftime("%d %b %Y") if now else '' }}</p>
  <p id="summaryText">Loading today‚Äôs attendance...</p>
</div>

<div id="videoSection" class="my-3 hidden">
  <video id="video" autoplay playsinline class="w-64 h-48 border rounded"></video><br>
  <button id="captureBtn" class="bg-blue-600 text-white px-3 py-1 rounded mt-2">üì∏ Capture Photo</button>
</div>

<canvas id="canvas" width="320" height="240" class="hidden"></canvas>

<div id="actions" class="flex gap-3 mt-4">
  <button id="checkinBtn" class="bg-green-600 text-white px-4 py-2 rounded">Check-In</button>
  <button id="checkoutBtn" class="bg-red-600 text-white px-4 py-2 rounded">Check-Out</button>
</div>

<div class="mt-4">
  <textarea id="remarks" rows="3" placeholder="Optional: add remark or note for today..."
    class="border w-full rounded p-2 text-sm"></textarea>
</div>

<div id="result" class="mt-4 text-sm"></div>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const captureBtn = document.getElementById("captureBtn");
let currentAction = null;
let currentBlob = null;

// --- Camera setup ---
async function setupCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;
    document.getElementById('videoSection').classList.remove('hidden');
  } catch (err) {
    alert("Camera access denied. Please allow camera.");
  }
}

captureBtn.onclick = () => {
  const ctx = canvas.getContext("2d");
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  canvas.toBlob(blob => {
    currentBlob = blob;
    document.getElementById('videoSection').classList.add('hidden');
    document.getElementById('result').innerHTML =
      `<p class='text-green-700'>Photo captured ‚úÖ Ready to submit.</p>`;
    submitAttendance();
  }, "image/jpeg");
};

// --- Attendance ---
async function submitAttendance() {
  if (!currentAction || !currentBlob) return;
  const formData = new FormData();
  formData.append("file", currentBlob, `${currentAction}.jpg`);
  formData.append("lat", window._lat || "");
  formData.append("lng", window._lng || "");
  formData.append("remarks", document.getElementById("remarks").value || "");

  const url = `/attendance/${currentAction}`;
  const res = await fetch(url, {
    method: "POST",
    headers: { Accept: "application/json" },
    body: formData
  });
  const data = await res.json();
  if (data.ok) {
    document.getElementById("result").innerHTML =
      `<p class='text-blue-700 font-medium'>
         ${currentAction === 'checkin' ? 'Check-in' : 'Check-out'} successful!<br>
         Time: ${new Date().toLocaleTimeString()}<br>
         Points: +${data.points_awarded}
       </p>`;
    loadStatus();
  } else {
    alert("Error submitting attendance");
  }
  currentBlob = null;
  currentAction = null;
}

// --- Location ---
navigator.geolocation.getCurrentPosition(pos => {
  window._lat = pos.coords.latitude;
  window._lng = pos.coords.longitude;
}, () => console.log("Location denied"));

// --- Buttons ---
document.getElementById("checkinBtn").onclick = () => {
  currentAction = "checkin";
  setupCamera();
};
document.getElementById("checkoutBtn").onclick = () => {
  currentAction = "checkout";
  setupCamera();
};

// --- Load daily status ---
async function loadStatus() {
  const res = await fetch("/attendance/today");
  const data = await res.json();
  if (data.ok && data.record) {
    const r = data.record;
    let txt = "";
    if (r.check_in_ts) {
      txt += `‚úÖ Checked-in at ${new Date(r.check_in_ts).toLocaleTimeString()}<br>`;
      document.getElementById("checkinBtn").disabled = true;
      document.getElementById("checkinBtn").classList.add("opacity-50");
    }
    if (r.check_out_ts) {
      txt += `üèÅ Checked-out at ${new Date(r.check_out_ts).toLocaleTimeString()}<br>`;
      document.getElementById("checkoutBtn").disabled = true;
      document.getElementById("checkoutBtn").classList.add("opacity-50");
    }
    if (r.working_hours) txt += `üïí Total: ${r.working_hours} hours<br>`;
    txt += `Status: <b>${r.status || 'N/A'}</b><br>`;
    txt += `Late count this month: ${data.late_count} | Pay-cut days: ${data.paycut_days}`;
    document.getElementById("summaryText").innerHTML = txt;
  } else {
    document.getElementById("summaryText").innerHTML = "No attendance marked yet.";
  }
}
loadStatus();
setInterval(loadStatus, 30000); // refresh every 30 s
</script>
{% endblock %}
