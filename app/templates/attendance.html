{% extends 'base.html' %}
{% block c %}
<h1 class="text-xl font-semibold mb-3">Attendance Portal</h1>

<div id="statusBox" class="mb-4 text-sm text-gray-700">
  <p id="summaryText">Loading today‚Äôs attendance...</p>
</div>

<div id="videoSection" class="my-3 hidden">
  <video id="video" autoplay playsinline class="w-64 h-48 border rounded"></video><br>
  <button id="captureBtn" class="bg-blue-600 text-white px-3 py-1 rounded mt-2">üì∏ Capture Photo</button>
</div>

<canvas id="canvas" width="320" height="240" class="hidden"></canvas>

<div class="mt-3">
  <textarea id="remarks" rows="3" placeholder="Optional: add remark or note for today..."
    class="border w-full rounded p-2 text-sm"></textarea>
</div>

<div id="actions" class="flex gap-3 mt-3">
  <button id="checkinBtn" class="bg-green-600 text-white px-4 py-2 rounded">Check-In</button>
  <button id="checkoutBtn" class="bg-red-600 text-white px-4 py-2 rounded">Check-Out</button>
</div>

<div id="result" class="mt-4 text-sm"></div>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const captureBtn = document.getElementById("captureBtn");
const result = document.getElementById("result");
const checkinBtn = document.getElementById("checkinBtn");
const checkoutBtn = document.getElementById("checkoutBtn");
let currentAction = null;
let currentBlob = null;

async function setupCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
    video.srcObject = stream;
    document.getElementById("videoSection").classList.remove("hidden");
  } catch (e) { alert("Camera blocked. Please allow camera permissions."); }
}

captureBtn.onclick = () => {
  const ctx = canvas.getContext("2d");
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  canvas.toBlob(blob => {
    currentBlob = blob;
    document.getElementById("videoSection").classList.add("hidden");
    result.innerHTML = "<p class='text-green-700'>Photo captured ‚úÖ</p>";
    submitAttendance();
  }, "image/jpeg", 0.9);
};

navigator.geolocation.getCurrentPosition(
  pos => { window._lat = pos.coords.latitude; window._lng = pos.coords.longitude; },
  () => {}, { enableHighAccuracy: true, timeout: 8000 }
);

checkinBtn.onclick = () => { currentAction = "checkin"; setupCamera(); };
checkoutBtn.onclick = () => { currentAction = "checkout"; setupCamera(); };

async function submitAttendance() {
  if (!currentAction || !currentBlob) return;
  const fd = new FormData();
  fd.append("file", currentBlob, `${currentAction}.jpg`);
  fd.append("lat", window._lat || "");
  fd.append("lng", window._lng || "");
  fd.append("remarks", document.getElementById("remarks").value || "");

  const res = await fetch(`/attendance/${currentAction}`, {
    method: "POST", headers: { "Accept": "application/json" }, body: fd
  });
  const data = await res.json();
  if (!data.ok) {
    alert(data.error || "Failed");
    return;
  }
  result.innerHTML = `<div class="text-blue-700">Success! Points: +${data.points_awarded}</div>`;
  await loadStatus();
}

async function loadStatus() {
  const r = await fetch("/attendance/today");
  const data = await r.json();
  if (data.ok) {
    const rec = data.record;
    let txt = "";
    if (rec && rec.check_in_ts) {
      txt += `‚úÖ Check-in: ${new Date(rec.check_in_ts).toLocaleTimeString()}<br>`;
      checkinBtn.disabled = true; checkinBtn.classList.add("opacity-50");
    } else {
      checkinBtn.disabled = false; checkinBtn.classList.remove("opacity-50");
    }
    if (rec && rec.check_out_ts) {
      txt += `üèÅ Check-out: ${new Date(rec.check_out_ts).toLocaleTimeString()}<br>`;
      checkoutBtn.disabled = true; checkoutBtn.classList.add("opacity-50");
    } else {
      checkoutBtn.disabled = false; checkoutBtn.classList.remove("opacity-50");
    }
    if (rec && rec.working_hours) txt += `üïí Total: ${rec.working_hours} hours<br>`;
    if (rec && rec.status) txt += `Status: <b>${rec.status}</b><br>`;
    txt += `Lates this month: ${data.late_count} | Pay-cut days: ${data.paycut_days}`;
    document.getElementById("summaryText").innerHTML = txt || "No attendance yet.";
  } else {
    document.getElementById("summaryText").innerHTML = "No attendance yet.";
  }
}
loadStatus();
setInterval(loadStatus, 30000);
</script>
{% endblock %}
